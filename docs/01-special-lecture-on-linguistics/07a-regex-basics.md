# 正規表現—基礎編
## 言葉のパターンを見抜く「魔法の呪文」

[__6. 中納言__](06-chunagon.md)で、私たちは精密な検索ツールを手に入れました。「食べる」という動詞のすべての活用形をまとめて検索したり、「〜にありつく」のような複雑なコロケーションを探したりすることができるようになりました。

しかし、探偵である私たちが解き明かしたい言葉の謎は、もっと複雑です。

- 「『〜たり』で終わる動詞をすべて検索したい」
- 「3文字のカタカナで始まる名詞を調べたい」
- 「『ぴかぴか』『きらきら』のような繰り返しのオノマトペを網羅的に探したい」

こうした「パターンを持つ文字列」を探すには、これまでの検索方法では不十分です。そこで登場するのが、「正規表現」という強力な「魔法の呪文」です。正規表現は、探偵が容疑者の特徴を「身長170〜180cm、黒髪、コンタクトレンズ着用」のように記述するのと似ています。「この特徴に当てはまる人物をすべて探せ」という指示を、コンピュータに正確に伝えるための呪文です。

!!! info "この章で学ぶこと"
    - 正規表現とは何か、その基本概念を理解する。
    - 基本的なメタ文字（`.` `*` `+` `|` `()` `[]`など）の使い方を身につける。
    - 繰り返しパターンを表現できるようになる。

## 文字列という「証拠」の世界
まず、**文字列**（string）という概念を確認しましょう。文字列とは、その名の通り、文字を並べたものです。たとえば、「文字を並べたものです」も文字列であり、「A,$^1B」や「あ方３ーヒ☆」といった意味をなさない文字の並びも文字列の例です。

コーパスは「検索可能な文字列」で構成されています。そのため、文字列の検索・操作能力は、そのままコーパスの検索・操作能力につながると考えることができます。

自分が作成したレポートや文書、あるいは、ウェブブラウザ上で特定の文字列を探した経験が1回くらいはあるのではないでしょうか。多くのアプリやウェブブラウザでは、`Ctrl+F`（`command+F`）を押すことで文字列の検索ができるボックスが現れます。

!!! example "まずは普通の検索から"
    === "① このくらいは誰でもできる"

        ウェブブラウザの検索機能を利用して、以下の文字列を検索してみてください。
        
        - 言語学
        - 日本語学
        - 心理学

    === "② これはできないかも"
        では、「言語学」「日本語学」「心理学」のように、「〜学」という言葉をすべてまとめて検索したい場合、どうすればいいでしょうか？
                
    === "③ パターンを考える"
        これらの言葉には共通のパターンがあります。

        - 言語学
        - 日本語学
        - 心理学
        
        たとえば、「漢字2文字以上」＋「学」のようなパターンがあると考えることができます。何かしらの方法で、このパターンを表現できれば、「〜学」という言葉を網羅的に検索できるはずです。

## 正規表現という「魔法の呪文」
**正規表現**（regular expression, regex）は、「パターンにマッチする文字列群を記述するための簡潔で強力なミニ言語」[@randal2018, p.121]のことです。探偵の世界で言えば、正規表現は「容疑者の特徴を記述する専門用語」のようなものです。

!!! tip "AIに正規表現を説明してもらおう"
    2025年現在、AIは正規表現の学習において非常に強力な味方になります。
    
    ``` { .text .copy title="プロンプト" }
    私は「正規表現」という表現を今日初めて聞きました。
    正規表現「[一-龠]{2,}学」について説明してください。
    - 各記号は何を意味するのか。
    - なぜこれで「言語学」「心理学」などにマッチするのか。
    - 初心者にもわかりやすく、具体例を交えて教えてください。
    ```
    
    まさか、「AIが正規表現を書いてくれたり、教えてくれたりするのであれば覚える必要がないのでは？」と思う人はいないでしょうね。

## メタ文字
[__5. NLBとNLT__](05-nlb-nlt.md)で調べた「満面の笑み」「満面の笑顔」を思い出してください。たとえば、「満面の笑み」と「満面の笑顔」「満面のスマイル」「満面の笑み（スマイル）」「満面の笑顔 (≧▽≦)」などの「満面の～」というパターンにマッチさせるために、次のような正規表現を書くことが考えられます（他にも方法はある）。

```
満面の.{2,}
```

ここで、「満面の」以外の文字列は、それぞれ次のような意味を表しています。


| 部分 | 意味 |
|------|------|
| `満面の` | 「満面の」という文字列そのもの |
| `.` | 任意の1文字 |
| `{2,}` | 2回以上の繰り返し |

つまり、「満面の＋任意の文字2文字以上」というパターンです。まだ何が何だかわからないって？それでは実際に呪文を唱えてみましょう。

!!! example "アブラカタブラ"
    
    === "① 百聞は一見にしかず"
        文字列と正規表現を入力して、正規表現が実際にどんな文字列にマッチするのかを確認してみましょう。下の方にあるかわいい「Regex Widget」を使ってみることにします。       
        
    === "② 文字列と正規表現の入力"  
        以下の文字列をコピーして、「Target Text」のところに貼り付けましょう。

        ``` { .text .copy title="文字列" }
        満面の笑み
        満面の笑顔
        満面のスマイル
        満面の
        ```
        
        そして、以下の「満面の」の次にある正規表現は、コピペではなく、「手で打ち込んで」みましょう。

        ``` { .text title="正規表現" }
        満面の.{2,}
        ```
        
        正規表現にマッチした部分はハイライトされます。「満面の」だけの行はマッチしないことを確認してください。

    === "③ 呪文を唱える"
        `{2,}`のところにある数字を変えて、どのようにハイライトが変わるのか確認してみましょう。
        
        - `{1,}` → 1文字以上
        - `{3,}` → 3文字以上
        - `{1,3}` → 1文字以上3文字以下
        - `{2}` → ちょうど2文字（カンマなし）

<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>

正規表現では、通常の文字とは別に、特別な意味を持つ**メタ文字**（metacharacter）を使います。これらは、探偵が使う「暗号」や「記号」のようなものです。

!!! warning "メタ文字は半角で！"
    正規表現に使う記号（メタ文字）は、すべて半角で入力してください。
    
    ❌ 全角：`．`　`（）`　`［］`　`＊`
    ✅ 半角：`.`　`()`　`[]`　`*`
    
    また、自分の手で入力する習慣をつけましょう。コピペだけでは身につきません。

### 任意の文字
ピリオド（`.`）は、「任意の1文字」を表します。改行以外のどんな文字にもマッチします。

```
早く家に帰りたい
```

この文字列に対して、`.`は「早」「く」「家」「に」「帰」「り」「た」「い」のそれぞれ1文字にマッチします。

!!! example "「.」を試してみる"
    
    ``` { .text .copy title="文字列" }
    あいうえお
    12345
    abc
    ```

    ``` { .text title="正規表現" }
    .
    ```
    
<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>

### 繰り返し
文字列の繰り返しを表すためには、次のようなメタ文字を使うことができます。

| メタ文字 | 意味 |
|---------|------|
| `*` | 直前のパターンの0回以上の繰り返し |
| `+` | 直前のパターンの1回以上の繰り返し |

たとえば、「早く家に帰りたい」という文字列は、任意の文字が8回繰り返されていると考えることができます。正規表現として、`.*`を入力してみましょう。今度は「*」の代わりに「+」を入れてみましょう。何が違うのでしょうか。


違いは「0回」を含むかどうかです。

```mermaid
graph TD
    A[繰り返しの表現] --> B["*"]
    A --> C["+"]
    
    B --> B1[0回以上<br/>空文字列もOK]
    C --> C1[1回以上<br/>最低1回は必要]
    
    B -.例.-> E1["a* → 空、a、aa、aaa..."]
    C -.例.-> E2["a+ → a、aa、aaa..."]
    
    style A fill:#e1f5ff
    style B fill:#ffcdd2
    style C fill:#c8e6c9
```

!!! example "「*」と「+」の違いを体験する"
    
    === "① 言語学.*"
        
        ``` { .text .copy title="文字列" }
        言語学
        言語学者
        言語学的
        言語学についての研究
        ```
        
        ``` { .text title="正規表現" }
        言語学.*
        ```
                
    === "② 言語学.+"
    
        ``` { .text .copy title="正規表現" }
        言語学.+
        ```
            
    === "③ 違いを確認"

        `*`は「0回以上」なので、「言語学」の後ろに何もなくてもマッチします。
        
        一方、`+`は「1回以上」なので、「言語学」の後ろに最低1文字必要です。

<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>

### 繰り返し回数の指定
より細かく繰り返し回数を指定したい場合は、波括弧（`{}`）を使います。

| 記法 | 意味 |
|------|------|
| `{n}` | ちょうどn回 |
| `{n,}` | n回以上 |
| `{n,m}` | n回以上m回以下 |

!!! example "繰り返し回数を指定する"
    
    ``` { .text .copy title="文字列" }
    あ
    ああ
    あああ
    ああああ
    あああああ
    ```
    
    ``` { .text title="正規表現" }
    あ{2}
    あ{2,}
    あ{2,4}
    ```

<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>

### または

[__6. 中納言__](06-chunagon.md)で、「どうりで」と「どおりで」の両方を検索したことを思い出してください。正規表現で表す場合には、パイプ記号（`|`）で「または」を表します。

| メタ文字 | 意味 |
|---------|------|
| `\|` | `\|`の前後に書かれた文字列のどちらか |

つまり、`どうりで|どおりで`は、「『どうりで』または『どおりで』」という意味です。

!!! example "YES or YES"
    
    ``` { .text .copy title="文字列" }
    どうりで腹が減るわけだ
    どおりで鼻が効くわけだな
    道理で見たところ粋で愛想がいい
    ```
    
    ``` { .text title="正規表現" }
    どうりで|どおりで|道理で
    ```

<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>

### グループ化
正規表現を書くときには、なるべく短く書くことが美徳とされています。たとえば、先ほどの「どうりで|どおりで」は、次のようにグループ化することでもっと短く表せます。

```
ど(う|お)りで
```

ここで丸括弧（`()`）には、2つの重要な役割があります。

| メタ文字 | 意味 |
|---------|------|
| `()` | 1. グループ化<br/>2. キャプチャー（記憶） |

#### グループ化
グループ化は、二つ以上の選択肢を与えることができます。たとえば、`日本(そして|また|あるいは|もしくは|ないし|・)韓国`のように書くことで、次の【接続詞】のところに自分が指定した接続詞や約物がある文のみを検索対象とすることができます。

- 日本【接続詞】韓国においては、働き手不足によって、外国人労働者の受け入れが政府の…

!!! example "グループになりましょう"
    
    ``` { .text .copy title="文字列" }
    日本そして韓国においては、働き手不足によって、外国人労働者の受け入れが政府の…
    日本ないし韓国においては、働き手不足によって、外国人労働者の受け入れが政府の…
    日本・韓国においては、働き手不足によって、外国人労働者の受け入れが政府の…
    日本、韓国においては、働き手不足によって、外国人労働者の受け入れが政府の…
    日本、そして、韓国においては、働き手不足によって、外国人労働者の受け入れが政府の…
    日本と韓国においては、働き手不足によって、外国人労働者の受け入れが政府の…
    ```
    
    ``` { .text title="正規表現" }
    日本(そして|また|あるいは|もしくは|ないし|・)韓国
    ```
    
    マッチしていない例もマッチさせるには、どのようにすればいいでしょうか？

<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>

!!! tip "校閲者の仕事"
    好みにより、句読点の組み合わせを決めている人がいると思います（「、」「，」「。」「．」）。グループ化を利用すると、複数人が書いた文書の中にある記号を統一させるのも簡単にできます。たとえば、10人が書いた文書の中にある句読点をすべて「，」と「．」の組み合わせに変更することが考えられます。

#### キャプチャー機能
`()`には、キャプチャー（capture）という強力な機能もあります。キャプチャーは「記憶」と読み替えてもいいでしょう。キャプチャーしておいた文字（列）は`\1`、`\2`、`\3`などを利用して、参照することができます。

| 参照 | 意味 |
|------|------|
| `\1` | 1番目の`()`でキャプチャーした内容 |
| `\2` | 2番目の`()`でキャプチャーした内容 |
| `\3` | 3番目の`()`でキャプチャーした内容 |

!!! example "ちゃんと覚えとけ"
    === "① 言語学.*"
        ``` { .text .copy title="文字列" }
        日本と韓国は人手不足で困っている。最近は、韓国も日本のように、海外からの…
        ```

        ``` { .text title="正規表現" }
        (日本).(韓国).+\2.\1
        ```

    === "② ばかみたい"
        キャプチャーを参照するときの制限はありません。たとえば、「だめだめだめよ だめなのよ」のような文字列の場合、最初の「だめ」をキャプチャーし、2回目以降の「だめ」を参照するために、次のように正規表現を書くことができます。        
        ``` { .text .copy title="文字列" }
        だめだめだめよ だめなのよ
        ```        
        ``` { .text title="正規表現" }
        (だめ)\1\1..\1
        ```        
        上記「だめだめだめよ だめなのよ」には半角空白が一つ含まれていますが、任意の文字を意味する「.」は空白にもマッチします。

    === "③ オノマトペ"
        キャプチャー機能は、オノマトペのような繰り返しパターンを検索するときに非常に便利です。
        
        ``` { .text .copy title="文字列" }
        きらきら
        どきどき
        わくわく
        ふわさく
        ```

        ``` { .text title="正規表現" }
        ([ぁ-ん]{2})\1
        ```      

        ここで`([ぁ-ん]{2})`は「ひらがな2文字」を意味します。つまり、この正規表現は「ひらがな2文字の繰り返し」にマッチします。「ふわさく」は、前半と後半が違うのでマッチしません。

<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>

## 文字クラス
角括弧（`[]`）は、**文字クラス**（character class）を表します。文字クラスは「この中のどれか1文字」を意味します。

| メタ文字 | 意味 |
|---------|------|
| `[]` | `[]`の中にある複数の文字のうち1文字 |

先ほどの「どうりで」と「どおりで」は、グループ化以外にも、文字クラス「[]」を利用してマッチさせることもできます。

```
ど[うお]りで
```

!!! example "練習あるのみ"
    === "① 初級"
        まずは、「一億円・二億円・三億円」にマッチする正規表現を書いてみましょう。

        ``` { .text .copy title="文字列" }
        一億円
        二億円
        三億円
        十億円
        一億ドル
        二十億ドル
        1億円
        10億円
        50億ドル
        500億ドル
        ```

    === "② 中級"
        次は、「一億ドル」と「二十億ドル」にもいっしょにマッチさせてみましょう。

    === "③ 上級"
        最後に、数字を含むすべての文字列にマッチする正規表現を書いてみましょう。

<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>

!!! note "グループ化と文字クラスの違い"
    グループ化 `()`は、複数の文字列から選ぶことになります。

    - `(そして|また|あるいは)` → 「そして」または「また」または「あるいは」
    
    一方、文字クラス `[]`は、複数の文字から1文字を選ぶという意味です。

    - `[うお]` → 「う」または「お」（1文字）

### ハイフンで範囲を指定
文字クラスの強力な機能の一つが、ハイフン（`-`）を使った範囲指定です。これは、「～から～まで」という意味で、たとえば、「aからzまで」は`[a-z]`で表すことができます。

#### 英語・数字の場合

```
[a-z]    → 小文字のaからzまで
[A-Z]    → 大文字のAからZまで
[a-zA-Z] → すべてのアルファベット
[0-9]    → 数字（0から9まで）
[a-zA-Z0-9] → アルファベットと数字
```

!!! example "英語の文字クラスを試す"
    

    
    === "小文字のみ"
        ``` { .text .copy title="文字列" }
        It's 6 p.m. I wanna GO home.
        ```

        ``` { .text title="正規表現" }
        [a-z]+
        ```
        「I」「GO」などの大文字と、アポストロフィやピリオド、そして、数字以外のすべてのアルファベットにマッチします。
        
    === "大文字も含める"
        ``` { .text title="正規表現" }
        [a-zA-Z]+
        ```
        すべてのアルファベットの連続にマッチします。
        
    === "数字も含める"
        ``` { .text title="正規表現" }
        [a-zA-Z0-9]+
        ```
        アルファベットと数字の連続にマッチします。

<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>

#### 日本語の場合
日本語の文字も、同じように範囲指定できます。これは、**Unicode**（文字コード）の識別番号を利用しています。

```mermaid
graph TD
    A[日本語の文字クラス] --> B[漢字]
    A --> C[ひらがな]
    A --> D[カタカナ]
    
    B --> B1["[一-龠]"]
    C --> C1["[ぁ-ん]"]
    D --> D1["[ァ-ヴー]"]
    
    B -.例.-> E1[言語学、愛媛、研究...]
    C -.例.-> E2[ひらがな、あいうえお...]
    D -.例.-> E3[カタカナ、アイウエオ...]
    
    style A fill:#e1f5ff
    style B fill:#ffcdd2
    style C fill:#c8e6c9
    style D fill:#fff9c4
```

| 文字種 | 正規表現 | 説明 |
|--------|---------|------|
| 漢字 | `[一-龠]` | 常用漢字・常用外漢字 |
| ひらがな | `[ぁ-ん]` | すべてのひらがな |
| カタカナ | `[ァ-ヴー]` | すべてのカタカナ（長音を含む） |

!!! example "君の名は。"
    `[一-龠]`を利用して、自分の名前がちゃんとマッチしているのか確認してみましょう。

    ``` { .text .copy title="文字列" }
    遠藤・川澤・久保・河野・杉山・土田・松岡・大西・小掠・田中・宮内・免出・松本
    ```

<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>

!!! note "文字コードについて"
    「一」から「龠」までの範囲指定が、なぜこのように漢字をカバーすることができるのでしょうか？これは、Unicodeという国際規格で、文字に連続した番号が割り当てられているからです。
    
    - 「一」は U+4E00
    - 「龠」は U+9FA0
    
    この範囲に、日常的に使われる漢字のほとんどが含まれています。詳しく知りたい場合は、以下のサイトを参照してください。
    
    - 漢字：[https://www.tamasoft.co.jp/en/general-info/unicode.html](https://www.tamasoft.co.jp/en/general-info/unicode.html)
    - ひらがな：[https://symbl.cc/en/unicode/blocks/hiragana/](https://symbl.cc/en/unicode/blocks/hiragana/)
    - カタカナ：[https://symbl.cc/en/unicode/blocks/katakana/](https://symbl.cc/en/unicode/blocks/katakana/)

!!! example "日本語の文字クラスを試す"
    
    === "漢字のみ抽出"

        ``` { .text .copy title="文字列" }
        これは日本語のセンテンスです。
        ```
        
        ``` { .text title="正規表現" }
        [一-龠]+
        ```
        
        「日本語」にマッチします。
        
    === "ひらがなのみ抽出"
        ``` { .text title="正規表現" }
        [ぁ-ん]+
        ```
        
        「これは」「の」「です」にマッチします。
        
    === "すべての日本語"
        ``` { .text title="正規表現" }
        [一-龠ぁ-んァ-ヴー]+
        ```
        
        （約物以外）日本語の文字すべてにマッチします。

<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>

### オノマトペの検索
キャプチャーと文字クラスを組み合わせると、卒業論文の常連テーマであるオノマトペのような繰り返しパターンを検索できます。

!!! example "オノマトペを検索する"
    今回は、文字列がちょっと長いので[ここ](https://regex101.com/r/6zYFZ0/1)に接続してやってみましょう。
    
    === "ひらがなのオノマトペ"
        ``` { .text title="正規表現" }
        ([ぁ-ん]{2})\1
        ```
        「きらきら」「あつあつ」などにマッチします。
        
    === "カタカナのオノマトペ"
        ``` { .text title="正規表現" }
        ([ァ-ヴー]{2})\1
        ```
        
        「ドキドキ」「ワクワク」「ピカピカ」などにマッチします。
        
    === "両方に対応"
        ``` { .text title="正規表現" }
        ([ぁ-んァ-ヴー]{2})\1
        ```
        
        （2文字の繰り返しが見られる）ひらがなとカタカナがのオノマトペにマッチします。

### 韓国語の文字クラス
韓国語（ハングル）も、正規表現を利用して範囲を指定することができます。

```
[가-힣]
```

この呪文は、すべてのハングル（가から힣まで）を表しています。

!!! example "韓国語を検索する"
    
    ``` { .text .copy title="文字列" }
    시작은 달콤하게 평범하게 나에게 끌려
    언제나 그랬듯이 먼저 말을 걸어와
    모든 가능성 열어둬 oh

    始まりはそうさ　こういつも平凡さ
    僕は心を　操れるから
    鍵　開けておくよ　Oh
    ```
    
    ``` { .text title="正規表現" }
    [가-힣]+
    ```

<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>
