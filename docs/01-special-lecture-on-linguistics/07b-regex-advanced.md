# 正規表現—応用編
## より精密な「捜査技術」を身につける

[__7. 正規表現—基礎編__](07a-regex-basics.md)で、私たちは正規表現という「魔法の呪文」の基礎を学びました。`.`（任意の文字）、`*`や`+`（繰り返し）、`()`（グループ化）、`[]`（文字クラス）など、探偵が容疑者の特徴を記述するための基本的な記号を手に入れました。

しかし、言葉の探偵として解決すべき謎は、もっともっと複雑なときがあります。

- 「カッコで囲まれたテキストだけを抽出したいけど、入れ子になっているカッコはどうすればいい？」
- 「HTMLタグを削除したいけど、貪欲マッチだと全部消えてしまう…」

こうした高度な捜査には、より精密な技術が必要です。この章では、正規表現の「奥義」とも言える高度なテクニックを学んでいきます。

!!! info "この章で学ぶこと"
    - 先読み・後読みで、特定のパターンの前後を条件に検索できるようになる。
    - 非貪欲マッチで、必要最小限のマッチを実現できるようになる。
    - 否定文字クラスで、「〜以外」という条件を表現できるようになる。
    - エスケープで、メタ文字を普通の文字として扱えるようになる。

## 基礎編のおさらい

まず、基礎編で学んだ内容を整理しておきましょう。

| メタ文字 | 意味 | 例 | マッチする例 |
|---------|------|-----|------------|
| `.` | 任意の1文字 | `満面.笑` | 満面の笑／満面ノ笑 |
| `*` | 0回以上 | `言語学.*` | 言語学／言語学者 |
| `+` | 1回以上 | `[ぁ-ん]+` | あ／あいうえお |
| `{n}` | ちょうどn回 | `あ{3}` | あああ |
| `{n,}` | n回以上 | `あ{2,}` | ああ／あああ... |
| `{n,m}` | n〜m回 | `あ{2,4}` | ああ／あああ／ああああ |
| `|` | または | `日本|韓国` | 日本／韓国 |
| `()` | グループ化・キャプチャー | `(ぴか)\1` | ぴかぴか |
| `[]` | 文字クラス | `[ぁ-ん]` | ひらがな1文字 |
| `?` | 直前のパターンの0か1回の出現 | `ですね。?` | ですね。／ですね |
| `^` | 文字列の先頭 |  |  |
| `$` | 文字列の末尾 |  |  |
| `\s` | 半角・全角スペースやタブなどの空白 |
| `\S` | \s 以外 |
| `\w` | ワード文字（[A-Za-z0-9_]と同じ） |
| `\W` | \w 以外 |
| `\d` | 半角の数字（[0-9]と同じ） |
| `\D` | \d 以外（[^0-9]と同じ） |
| `\t` | タブ |

以下は、日本語にマッチさせるための文字クラスです。

| 文字種 | 文字クラス | 説明 |
|--------|---------|------|
| 漢字 | `[一-龠]` | 日常的に使われるほぼすべての漢字 |
| ひらがな | `[ぁ-ん]` | すべてのひらがな |
| カタカナ | `[ァ-ヴー]` | すべてのカタカナ |

## 先読み・後読み

探偵が現場を観察するとき、証拠を動かさずに「見るだけ」の場合があります。正規表現の**先読み**（lookahead）は、これに似ています。先読みは、「この後に○○が続くのか、続かないのか」という条件をチェックしますが、その部分自体はマッチの結果に含まれません。

### 肯定先読み `(?=...)`

**肯定先読み**（positive lookahead）は、「【パターン】の後に【条件】が続く」という条件を表します。

```
パターン(?=条件)
```

!!! example "それ、触らないで！"
    「言語学」「心理学」「社会学」などの「学」の前にある部分だけを抽出したいと考えてみましょう。。つまり、「言語」「心理」「社会」だけをマッチさせたいということです。
     
     ``` { .text .copy title="文字列" }
     言語学
     心理学
     社会学
     学校
     大学
     ```
     
     ``` { .text title="正規表現" }
     [一-龠]{2,}(?=学)
     ```
     
     上記の正規表現にマッチするのは「言語」「心理」「社会」のみです。「学」自体はマッチに含まれていないことを確認してください。この正規表現が意味するのを砕けて言うと、以下のようになります。
     
     - `[一-龠]{2,}` → 漢字2文字以上にマッチ
     - `(?=学)` → その後に「学」が続くことを確認（ただし「学」自体はマッチに含めない）

<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>

### 否定先読み `(?!...)`

**否定先読み**（negative lookahead）は、肯定先読みとは反対に、「【パターン】の後に【条件】が続かない」という条件を表します。

```
パターン(?!条件)
```

!!! example "目指すは日本"
    「日本」という単語を検索したいけれど、「日本語」や「日本人」といった複合語の一部として使われている場合は除外したい（国としての日本だけを抽出したい）場面を考えてみましょう。

    ``` { .text .copy title="文字列" }
    日本に行く
    日本語を学ぶ
    日本人の友達
    日本文化
    ```

    ``` { .text title="正規表現" }  
    日本(?!語|人)
    ```
    
    上記の正規表現では、「語」または「人」が後ろに続く「日本」にはマッチしません。
    
    - `日本` → まず「日本」という文字を探す
    - `(?!語|人)` → その直後に「語」または「人」が続かないことを確認    

<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>

### 肯定後読み `(?<=...)`

**後読み**（lookbehind）は、先読みの逆です。**肯定後読み**（positive lookbehind）は、「【パターン】の前に【条件】がある」という条件を表します。

```
(?<=条件)パターン
```

!!! example "「言語」の後の「学」だけを探す"
    「学」だけを抽出したいけど、「学」の前に「言語」がある例だけを抽出したい場面を考えてみましょう。
    
    ``` { .text .copy title="文字列" }
    言語学
    心理学
    社会学
    ```

    ``` { .text title="正規表現" }
    (?<=言語)学
    ```
    
    この正規表現は、以下の意味を表します。
    
    - `(?<=言語)` → 文字列の前に「言語」があることを確認
    - `学` → 「学」にマッチ
        
<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>

### 否定後読み `(?<!...)`

**否定後読み**（negative lookbehind）は、「【パターン】の前に【条件】がない」という条件を表します。

```
(?<!条件)パターン
```

!!! example "「大」が前にない「学」を探す"
    
    ``` { .text .copy title="文字列" }
    言語学
    心理学
    大学
    ```
    
    ``` { .text title="正規表現" }
    (?<!大)学
    ```
    
    この正規表現は「言語学」や「心理学」の「学」にはマッチしますが、「大学」の「学」にはマッチしません。

<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>

### 先読み・後読みの整理

| 記法 | 名前 | 意味 |
|------|------|------|
| `(?=...)` | 肯定先読み | この後に〜が続く |
| `(?!...)` | 否定先読み | この後に〜が続かない |
| `(?<=...)` | 肯定後読み | この前に〜がある |
| `(?<!...)` | 否定後読み | この前に〜がない |

## エスケープ—メタ文字を「普通の文字」として扱う

### メタ文字の問題

正規表現のメタ文字（`. * + ? | ( ) [ ] { } ^ $`など）を、文字として検索したい場合はどうすればいいでしょうか？

!!! example "ピリオドを検索したい"
    
    以下の文字列にある「3.14」の部分を抽出したい場面を考えてみましょう。

    ``` { .text .copy title="文字列" }
    価格は3.14ドルです。
    3a14
    3b14
    ```
    
    以下の正規表現では、うまくいきません。

    ``` { .text title="正規表現" }
    3.14
    ```
        
    `.`は「任意の1文字」を意味するので、「3a14」「3b14」などにもマッチしてしまいます。このような場面では`\`が役に立ちます。

    ``` { .text title="正規表現" }
    3\.14
    ```
 
    `\`（バックスラッシュ）でエスケープすると、`.`を文字として扱えます。

<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>

### エスケープが必要なメタ文字

以下のメタ文字を文字として扱いたい場合は、`\`で**エスケープ**します。

| メタ文字 | エスケープ | 例 |
|---------|----------|-----|
| `.` | `\.` | `3\.14` → 「3.14」 |
| `*` | `\*` | `2\*3` → 「2*3」 |
| `+` | `\+` | `1\+1` → 「1+1」 |
| `?` | `\?` | `本当\?` → 「本当?」 |
| `|` | `\|` | `A\|B` → 「A\|B」 |
| `(` `)` | `\(` `\)` | `\(注\)` → 「(注)」 |
| `[` `]` | `\[` `\]` | `\[1\]` → 「[1]」 |
| `{` `}` | `\{` `\}` | `\{2\}` → 「{2}」 |
| `^` | `\^` | `2\^3` → 「2^3」 |
| `$` | `\$` | `\$100` → 「$100」 |
| `\` | `\\` | `C:\\` → 「C:\」 |

!!! example "括弧で囲まれた数字を抽出"
    
    ``` { .text .copy title="文字列" }
    参考文献(1)を参照。詳細は(2)と(3)を見よ。
    ```
    
    ``` { .text title="正規表現" }
    \([0-9]+\)
    ```

<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>

## 実践的なパターン集

ここまで学んだ技術を使って、実際によく使われるパターンを見てみましょう。

### 日付の検索

!!! example "日付を抽出（YYYY-MM-DD形式）"
    
    === "① 簡易版"
        ``` { .text .copy title="文字列" }
        イベントは2025-11-22に開催されます。
        締切は2025-12-31です。
        ```
        
        ``` { .text title="正規表現" }
        \d{4}-\d{2}-\d{2}
        ```
        
    === "② より厳密な版"
        ``` { .text title="正規表現" }
        (19|20)\d{2}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])
        ```
        
        この正規表現の意味：
        
        - `(19|20)\d{2}` → 1900〜2099年
        - `(0[1-9]|1[0-2])` → 01〜12月
        - `(0[1-9]|[12]\d|3[01])` → 01〜31日

<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>

### 日本語の日付表記

!!! example "「2025年11月22日」形式"
    
    ``` { .text .copy title="文字列" }
    授業は2025年11月22日に行われます。
    締切は2025年12月31日です。
    ```
    
    ``` { .text title="正規表現" }
    \d{4}年\d{1,2}月\d{1,2}日
    ```

<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>

### 電話番号

!!! example "日本の電話番号"
    
    === "① ハイフンあり"
        ``` { .text .copy title="文字列" }
        連絡先：03-1234-5678
        携帯：090-1234-5678
        ```
        
        ``` { .text title="正規表現" }
        0\d{1,4}-\d{1,4}-\d{4}
        ```
        
    === "② ハイフンなし・あり両対応"
        ``` { .text title="正規表現" }
        0\d{1,4}-?\d{1,4}-?\d{4}
        ```
        
        `-?`は「ハイフンが0回または1回」を意味します。

<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>

### URL

!!! example "URLを抽出"
    
    ``` { .text .copy title="文字列" }
    詳細はhttps://example.comを参照。
    サブページはhttps://example.com/page/infoにあります。
    ```
    
    ``` { .text title="正規表現" }
    https?://[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}(/[^ ]*)?
    ```
    
    この正規表現の意味：
    
    - `https?` → httpまたはhttps
    - `://` → コロン＋スラッシュ2つ
    - `[a-zA-Z0-9.-]+` → ドメイン名
    - `\.` → ドット
    - `[a-zA-Z]{2,}` → トップレベルドメイン
    - `(/[^ ]*)?` → パス部分（オプション）

<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>

!!! tip "AIに実践的なパターンを相談"
    ``` { .text .copy title="プロンプト" }
    以下のパターンにマッチする正規表現を書いてください：
    
    1. 日本の郵便番号（例：123-4567）
    2. 日本語の金額表記（例：1,000円、10,000,000円）
    3. メールアドレス（簡易版でOK）
    
    それぞれについて：
    - 正規表現
    - 各部分の説明
    - 具体例
    
    を提示してください。
    ```

### 実践：「〜たり」の用法を調べる

[__1. 言語研究の技法__](01-language-research.md)で触れた「〜たり」の用法を、正規表現で詳しく調べてみましょう。

!!! example "「〜たり」の用法を分析"
    
    === "① 1回だけの「〜たり」"
        「泣いたり」のように、「〜たり」が1回だけ使われる例を検索してみましょう。
        
        ``` { .text title="正規表現" }
        [ぁ-ん]+たり(?![^。]*[ぁ-ん]+たり)
        ```
        
        この正規表現の意味：
        
        - `[ぁ-ん]+たり` → ひらがな＋「たり」
        - `(?![^。]*[ぁ-ん]+たり)` → その後に（句点までに）もう一つの「〜たり」がないことを確認
        
    === "② 2回の「〜たり〜たり」"
        「泣いたり笑ったり」のように、2回使われる例を検索してみましょう。
        
        ``` { .text title="正規表現" }
        [ぁ-ん]+たり.{1,20}[ぁ-ん]+たり
        ```
        
        この正規表現の意味：
        
        - 最初の「〜たり」
        - `.{1,20}` → 間に1〜20文字
        - 2番目の「〜たり」
        
    === "③ 結果を比較"
        検索結果をダウンロードして、以下の点を分析してみましょう。
        
        - 1回の「〜たり」と2回の「〜たり〜たり」、どちらが多い？
        - ジャンルによって違いはある？
        - 「〜たりして」のような特徴的なパターンは？

## トラブルシューティング—よくある間違いと解決法

### 正規表現が動かないとき

!!! warning "チェックリスト"
    
    1. メタ文字は半角？
    
        ❌ `．`（全角ピリオド）
        ✅ `.`（半角ピリオド）
    
    2. エスケープは正しい？
    
        ❌ `(1)` → `(`が開始括弧として解釈される
        ✅ `\(1\)` → 文字としての括弧
    
    3. 文字クラスの範囲は正しい？
    
        ❌ `[z-a]` → 範囲が逆
        ✅ `[a-z]` → 正しい範囲
    
    4. グループの対応は取れている？
    
        ❌ `(abc` → 閉じ括弧がない
        ✅ `(abc)` → 対応している

### 意図しない文字列にマッチするとき

!!! example "問題診断"
    
    === "① 問題を確認"
        「学校」「大学」にマッチさせたくないのに、マッチしてしまう。
        
        ``` { .text title="正規表現" }
        [一-龠]+学
        ```
        
    === "② 原因"
        「学校」の「学」にもマッチしてしまいます。
        
    === "③ 解決策"
        先読み・後読みを使います。
        
        ``` { .text title="正規表現" }
        [一-龠]{2,}学(?!校)
        ```
        
        この正規表現の意味：
        
        - `[一-龠]{2,}学` → 漢字2文字以上＋「学」
        - `(?!校)` → 後に「校」がない

<!-- 
### AIに正規表現を作ってもらう

!!! example "AIに正規表現を書いてもらう"
    
    ``` { .text .copy title="プロンプト" }
    以下の条件で正規表現を書いてください：
    
    1. 「〜たり」で終わる動詞を検索したい
    2. 「泣いたり」「笑ったり」「食べたり」などにマッチする
    3. ひらがなで書かれた動詞部分は1文字以上
    
    正規表現と、その説明をお願いします。
    ```
    
    AIの回答を検証する際には：
    
    1. AIが提案した正規表現を、上の「Regex Widget」でテストする
    2. 本当に意図した文字列にマッチするか確認する
    3. 意図しない文字列にもマッチしていないか確認する

### AIに正規表現を説明してもらう

!!! example "複雑な正規表現を理解する"
    
    ``` { .text .copy title="プロンプト" }
    以下の正規表現を、初心者にもわかるように説明してください：
    
    ([一-龠]{2,})(そして|また|あるいは)\1
    
    - 各部分が何を意味するのか
    - どんな文字列にマッチするのか
    - 具体例を3つ挙げてください
    ```

### AIにエラーを修正してもらう

!!! example "うまく動かない正規表現を直す"
    
    ``` { .text .copy title="プロンプト" }
    次の正規表現を書きましたが、うまく動きません：
    
    [ぁ-ん]+たり
    
    「泣いたり」「笑ったり」にマッチさせたいのですが、
    「ひらがなたり」のような意味のない文字列にもマッチしてしまいます。
    
    どう修正すればいいですか？
    また、もっと正確にマッチさせる方法はありますか？
    ``` -->

## 💻 やってみよう！
!!! example "基本：先読み・後読みを使う"

    === "① 「の」の前にある漢字を抽出（肯定先読み）"
        「言語の…」という文脈のとき、「の」を含まずに「言語」だけを抽出してみましょう。
        
        ``` { .text .copy title="文字列" }
        言語の研究は面白い。
        心理の世界を探る。
        ```
    
    === "② 「学的」を除外する（否定後読み）"
        「〜的」で終わる言葉のうち、「理論的」や「一般的」はOKですが、「言語学的」のように「学的」となるものは除外しましょう。
        
        ``` { .text .copy title="文字列" }
        理論的
        一般的
        言語学的
        科学的
        ```
    
    === "③ 特定の「〜する」を除外（否定先読み）"
        「〜する」という動詞の中で、「勉強する」「研究する」だけは除外して、それ以外をマッチさせましょう。
        
        ``` { .text .copy title="文字列" }
        勉強する
        研究する
        検索する
        開発する
        ```
        
<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>

!!! example "応用：実践的なパターンを作る"

    === "① 引用の中身だけを抽出"
        「〜」と『〜』の両方に対応し、括弧を含まずに中身だけを抽出できる正規表現を考えてみましょう。
        
        ``` { .text .copy title="文字列" }
        「これは引用です」と言った。
        『あれも引用です』と書いた。
        ```

        <!-- ヒント：「前には括弧開きがある（肯定後読み）」かつ「後ろには括弧閉じがある（肯定先読み）」というサンドイッチ構造を作ります。 -->
    
    === "② 複合動詞の「前側」をとる"
        「食べ始める」「走り出す」のように、後ろに補助的な動詞（〜始める、〜出す）がつく場合、その前の動詞部分だけ（「食べ」「走り」）を検索してみましょう。
        
        ``` { .text .copy title="文字列" }
        食べ始める
        走り出す
        考え直す
        書き終わる
        ```

        <!-- ヒント：`[一-龠]+[ぁ-ん]+(?=始める|出す)` のように、後ろに来る言葉を条件として指定します。 -->

    === "③ オリジナル課題"
        あなたの研究テーマに関連するパターンを考え、正規表現を作成してみましょう。たとえば：
        
        - 「〜という」の直前の名詞をとる
        - 特定の助詞の前後をとる

<iframe src="../../assets/viz/regex-visualizer-lite.html" width="100%" height="500" frameborder="0" style="border: none; display: block;"></iframe>
